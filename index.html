<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Comment Assistant</title>
    <style>
        :root {
            --color-background: #fcfcf9;
            --color-surface: #fffffd;
            --color-text: #134252;
            --color-text-secondary: #626c71;
            --color-primary: #21808d;
            --color-primary-hover: #1d7480;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-success: #21808d;
            --color-warning: #e68161;
            --color-danger: #c0152f;
            --radius-base: 8px;
            --radius-lg: 12px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: #1f2121;
                --color-surface: #262828;
                --color-text: #f5f5f5;
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: #32b8c6;
                --color-primary-hover: #2da6b2;
                --color-border: rgba(119, 124, 124, 0.3);
                --color-danger: #ff5459;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 32px;
            text-align: center;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--color-border);
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--color-text);
        }

        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .card-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #777;
        }

        .status-indicator.active {
            background: var(--color-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .input-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background: var(--color-surface);
            color: var(--color-text);
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-base);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--color-primary-hover);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(94, 82, 64, 0.05);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .btn-group button {
            flex: 1;
        }

        .feed-item {
            padding: 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feed-item:hover {
            border-color: var(--color-primary);
            background: rgba(33, 128, 141, 0.05);
        }

        .feed-item.selected {
            border-color: var(--color-primary);
            background: rgba(33, 128, 141, 0.1);
        }

        .feed-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .feed-item-text {
            font-size: 14px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .feed-source-tag {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(33, 128, 141, 0.1);
            border-radius: 12px;
            font-size: 11px;
            color: var(--color-primary);
            margin-top: 4px;
        }

        .comment-preview {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: 16px;
            margin-top: 16px;
        }

        .comment-preview-header {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .comment-text {
            padding: 12px;
            background: rgba(33, 128, 141, 0.05);
            border-radius: var(--radius-base);
            border-left: 3px solid var(--color-primary);
            font-size: 14px;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--color-text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-text-secondary);
        }

        .keywords-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .keyword-tag {
            background: rgba(33, 128, 141, 0.1);
            color: var(--color-primary);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .keyword-tag button {
            background: none;
            border: none;
            color: var(--color-primary);
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
        }

        .info-box {
            background: rgba(230, 129, 97, 0.1);
            border: 1px solid rgba(230, 129, 97, 0.3);
            border-radius: var(--radius-base);
            padding: 12px;
            font-size: 13px;
            margin-bottom: 16px;
            color: var(--color-text-secondary);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .profile-item {
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .profile-item:hover {
            border-color: var(--color-primary);
            background: rgba(33, 128, 141, 0.05);
        }

        .profile-item.active {
            border-color: var(--color-primary);
            background: rgba(33, 128, 141, 0.1);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .profile-meta {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .profile-actions {
            display: flex;
            gap: 8px;
        }

        .feed-list-item {
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .feed-url {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 12px;
            color: var(--color-text-secondary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí¨ RSS Comment Assistant</h1>
            <p class="subtitle">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö RSS.app —Ñ–∏–¥–æ–≤ —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏ –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Ç–µ–º—ã</p>
        </div>

        <div class="tabs" id="tabsContainer">
            <button class="tab active" onclick="switchTab('profiles')">üìÇ –ü—Ä–æ—Ñ–∏–ª–∏</button>
            <button class="tab" onclick="switchTab('monitoring')">üîÑ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
            <button class="tab" onclick="switchTab('feed')">üì∞ –õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤</button>
            <button class="tab" onclick="switchTab('comments')">‚úçÔ∏è –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ü—Ä–æ—Ñ–∏–ª–∏ -->
        <div id="tab-profiles" class="tab-content">
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <span>‚ûï</span>
                        <span>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å</span>
                    </div>

                    <div class="input-group">
                        <label for="newProfileName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</label>
                        <input type="text" id="newProfileName" placeholder="AI & –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è">
                    </div>

                    <div class="input-group">
                        <label for="newProfileKeywords">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä–µ–∑ Enter)</label>
                        <input type="text" id="newProfileKeywordsInput" placeholder="ai, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, python">
                        <div class="keywords-container" id="newProfileKeywordsContainer"></div>
                    </div>

                    <button class="btn btn-primary" onclick="createProfile()">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span>üìã</span>
                        <span>–í–∞—à–∏ –ø—Ä–æ—Ñ–∏–ª–∏</span>
                    </div>
                    <div id="profilesList">
                        <div class="empty-state">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ -->
        <div id="tab-monitoring" class="tab-content" style="display: none;">
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <span>‚öôÔ∏è</span>
                        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</span>
                    </div>

                    <div class="input-group">
                        <label for="apiKey">Perplexity API Key</label>
                        <input type="password" id="apiKey" placeholder="pplx-...">
                    </div>

                    <div class="input-group">
                        <label>–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</label>
                        <select id="activeProfileSelect">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</option>
                        </select>
                    </div>

                    <div class="info-box">
                        üí° –î–æ–±–∞–≤—å—Ç–µ RSS.app —Å—Å—ã–ª–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
                    </div>

                    <div class="input-group">
                        <label for="newFeedUrl">–î–æ–±–∞–≤–∏—Ç—å RSS.app —Ñ–∏–¥</label>
                        <input type="text" id="newFeedUrl" placeholder="https://rss.app/feeds/...xml">
                        <button class="btn btn-secondary" style="margin-top: 8px;" onclick="addFeedToProfile()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–¥</button>
                    </div>

                    <div id="currentProfileFeeds">
                        <label style="margin-top: 16px;">–§–∏–¥—ã –≤ –ø—Ä–æ—Ñ–∏–ª–µ:</label>
                        <div id="feedsList"></div>
                    </div>

                    <div class="input-group" style="margin-top: 20px;">
                        <label for="checkInterval">–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                        <select id="checkInterval">
                            <option value="10" selected>10 –º–∏–Ω—É—Ç</option>
                            <option value="15">15 –º–∏–Ω—É—Ç</option>
                            <option value="30">30 –º–∏–Ω—É—Ç</option>
                            <option value="60">60 –º–∏–Ω—É—Ç</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="dateFilter">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ—Å—Ç—ã –∑–∞</label>
                        <select id="dateFilter">
                            <option value="1">1 –¥–µ–Ω—å</option>
                            <option value="3" selected>3 –¥–Ω—è</option>
                            <option value="7">7 –¥–Ω–µ–π</option>
                            <option value="14">14 –¥–Ω–µ–π</option>
                            <option value="0">–í—Å–µ –≤—Ä–µ–º—è</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" id="startMonitoring" onclick="toggleMonitoring()">–ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="status-indicator" id="statusIndicator"></div>
                        <span>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</span>
                    </div>

                    <div style="font-size: 13px; color: var(--color-text-secondary);">
                        <div style="margin-bottom: 8px;">
                            <strong>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</strong> <span id="statusText">–ù–µ –∑–∞–ø—É—â–µ–Ω</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å:</strong> <span id="activeProfileName">‚Äî</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>–§–∏–¥–æ–≤ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ:</strong> <span id="activeFeedsCount">0</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –ø–æ—Å—Ç–æ–≤:</strong> <span id="postsChecked">0</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:</strong> <span id="commentsGenerated">0</span>
                        </div>
                        <div>
                            <strong>–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:</strong> <span id="nextCheck">‚Äî</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤ -->
        <div id="tab-feed" class="tab-content" style="display: none;">
            <div class="card full-width">
                <div class="card-header">
                    üì∞ –ù–æ–≤—ã–µ –ø–æ—Å—Ç—ã –ø–æ –≤–∞—à–∏–º —Ç–µ–º–∞–º
                </div>
                <div id="feedContainer">
                    <div class="empty-state">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ—Å—Ç–æ–≤</div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
        <div id="tab-comments" class="tab-content" style="display: none;">
            <div class="card full-width">
                <div class="card-header">
                    ‚úçÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                </div>

                <div id="generationArea" style="display: none;">
                    <div class="input-group">
                        <label>–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ—Å—Ç:</label>
                        <div id="selectedPostPreview" style="padding: 12px; background: rgba(33, 128, 141, 0.05); border-radius: var(--radius-base); font-size: 14px;"></div>
                    </div>

                    <div class="input-group">
                        <label for="commentStyle">–°—Ç–∏–ª—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è</label>
                        <select id="commentStyle">
                            <option value="professional">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π</option>
                            <option value="friendly">–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π</option>
                            <option value="expert">–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π</option>
                            <option value="question">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="generateComment()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>

                    <div id="commentPreviewArea" style="display: none;">
                        <div class="comment-preview">
                            <div class="comment-preview-header">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</div>
                            <div class="comment-text" id="generatedComment"></div>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="approveComment()">‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                            <button class="btn btn-secondary" onclick="regenerateComment()">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn btn-secondary" onclick="editComment()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>

                        <div class="input-group" id="editArea" style="display: none; margin-top: 16px;">
                            <label>–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                            <textarea id="editedComment" rows="4"></textarea>
                            <div class="btn-group" style="margin-top: 8px;">
                                <button class="btn btn-primary" onclick="saveEditedComment()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                                <button class="btn btn-secondary" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="noPostSelected" class="empty-state">
                    –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç –∏–∑ –ª–µ–Ω—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
        <div id="editProfileModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
                <div class="input-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</label>
                    <input type="text" id="editProfileName">
                </div>
                <div class="input-group">
                    <label>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä–µ–∑ Enter)</label>
                    <input type="text" id="editProfileKeywordsInput">
                    <div class="keywords-container" id="editProfileKeywordsContainer"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="saveProfileEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn btn-secondary" onclick="closeModal('editProfileModal')">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const state = {
            profiles: [],
            activeProfileId: null,
            monitoring: false,
            selectedPost: null,
            posts: [],
            processedPostIds: new Set(),
            stats: { postsChecked: 0, commentsGenerated: 0 },
            checkInterval: null,
            nextCheckTime: null,
            newProfileKeywords: [],
            editingProfileKeywords: []
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        function loadState() {
            const saved = localStorage.getItem('rssCommentAssistant');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.profiles = data.profiles || [];
                    state.activeProfileId = data.activeProfileId || null;
                    state.processedPostIds = new Set(data.processedPostIds || []);
                    state.stats = data.stats || { postsChecked: 0, commentsGenerated: 0 };
                    
                    const apiKey = data.apiKey || '';
                    if (apiKey) document.getElementById('apiKey').value = apiKey;
                    
                    const checkInterval = data.checkInterval || '10';
                    document.getElementById('checkInterval').value = checkInterval;
                    
                    const dateFilter = data.dateFilter || '3';
                    document.getElementById('dateFilter').value = dateFilter;
                    
                    renderProfiles();
                    updateActiveProfileSelect();
                    updateStats();
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
                }
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function saveState() {
            const data = {
                profiles: state.profiles,
                activeProfileId: state.activeProfileId,
                processedPostIds: Array.from(state.processedPostIds),
                stats: state.stats,
                apiKey: document.getElementById('apiKey').value,
                checkInterval: document.getElementById('checkInterval').value,
                dateFilter: document.getElementById('dateFilter').value
            };
            localStorage.setItem('rssCommentAssistant', JSON.stringify(data));
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            const clickedTab = event ? event.target : null;
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
            
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            
            if (tabName === 'monitoring') {
                updateFeedsList();
            }
        }

        // === –ü–†–û–§–ò–õ–ò ===
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
        document.getElementById('newProfileKeywordsInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.value.trim()) {
                const keyword = e.target.value.trim();
                if (!state.newProfileKeywords.includes(keyword)) {
                    state.newProfileKeywords.push(keyword);
                    renderNewProfileKeywords();
                }
                e.target.value = '';
            }
        });

        function renderNewProfileKeywords() {
            const container = document.getElementById('newProfileKeywordsContainer');
            container.innerHTML = state.newProfileKeywords.map((kw, idx) => `
                <span class="keyword-tag">
                    ${kw}
                    <button onclick="removeNewProfileKeyword(${idx})">√ó</button>
                </span>
            `).join('');
        }

        function removeNewProfileKeyword(index) {
            state.newProfileKeywords.splice(index, 1);
            renderNewProfileKeywords();
        }

        function createProfile() {
            const name = document.getElementById('newProfileName').value.trim();
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è');
                return;
            }
            
            const profile = {
                id: Date.now().toString(),
                name: name,
                keywords: [...state.newProfileKeywords],
                feeds: [],
                createdAt: new Date().toISOString()
            };
            
            state.profiles.push(profile);
            state.newProfileKeywords = [];
            
            document.getElementById('newProfileName').value = '';
            renderNewProfileKeywords();
            renderProfiles();
            updateActiveProfileSelect();
            saveState();
            
            alert(`‚úÖ –ü—Ä–æ—Ñ–∏–ª—å "${name}" —Å–æ–∑–¥–∞–Ω`);
        }

        function renderProfiles() {
            const container = document.getElementById('profilesList');
            
            if (state.profiles.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π</div>';
                return;
            }
            
            container.innerHTML = state.profiles.map(profile => `
                <div class="profile-item ${profile.id === state.activeProfileId ? 'active' : ''}">
                    <div class="profile-info">
                        <div class="profile-name">${profile.name}</div>
                        <div class="profile-meta">
                            ${profile.keywords.length} –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ ‚Ä¢ ${profile.feeds.length} —Ñ–∏–¥–æ–≤
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-secondary btn-small" onclick="setActiveProfile('${profile.id}')">
                            ${profile.id === state.activeProfileId ? '‚úì –ê–∫—Ç–∏–≤–µ–Ω' : '–í—ã–±—Ä–∞—Ç—å'}
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="editProfile('${profile.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-secondary btn-small" onclick="deleteProfile('${profile.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function setActiveProfile(profileId) {
            state.activeProfileId = profileId;
            renderProfiles();
            updateActiveProfileSelect();
            updateFeedsList();
            saveState();
        }

        function editProfile(profileId) {
            const profile = state.profiles.find(p => p.id === profileId);
            if (!profile) return;
            
            document.getElementById('editProfileName').value = profile.name;
            state.editingProfileKeywords = [...profile.keywords];
            renderEditProfileKeywords();
            
            document.getElementById('editProfileModal').classList.add('show');
            document.getElementById('editProfileModal').dataset.profileId = profileId;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const input = document.getElementById('editProfileKeywordsInput');
            input.onkeypress = (e) => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                    const keyword = e.target.value.trim();
                    if (!state.editingProfileKeywords.includes(keyword)) {
                        state.editingProfileKeywords.push(keyword);
                        renderEditProfileKeywords();
                    }
                    e.target.value = '';
                }
            };
        }

        function renderEditProfileKeywords() {
            const container = document.getElementById('editProfileKeywordsContainer');
            container.innerHTML = state.editingProfileKeywords.map((kw, idx) => `
                <span class="keyword-tag">
                    ${kw}
                    <button onclick="removeEditProfileKeyword(${idx})">√ó</button>
                </span>
            `).join('');
        }

        function removeEditProfileKeyword(index) {
            state.editingProfileKeywords.splice(index, 1);
            renderEditProfileKeywords();
        }

        function saveProfileEdit() {
            const modal = document.getElementById('editProfileModal');
            const profileId = modal.dataset.profileId;
            const profile = state.profiles.find(p => p.id === profileId);
            
            if (!profile) return;
            
            const newName = document.getElementById('editProfileName').value.trim();
            if (!newName) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è');
                return;
            }
            
            profile.name = newName;
            profile.keywords = [...state.editingProfileKeywords];
            
            closeModal('editProfileModal');
            renderProfiles();
            updateActiveProfileSelect();
            saveState();
        }

        function deleteProfile(profileId) {
            const profile = state.profiles.find(p => p.id === profileId);
            if (!profile) return;
            
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å "${profile.name}"?`)) return;
            
            state.profiles = state.profiles.filter(p => p.id !== profileId);
            
            if (state.activeProfileId === profileId) {
                state.activeProfileId = null;
            }
            
            renderProfiles();
            updateActiveProfileSelect();
            saveState();
        }

        function updateActiveProfileSelect() {
            const select = document.getElementById('activeProfileSelect');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</option>' +
                state.profiles.map(p => `
                    <option value="${p.id}" ${p.id === state.activeProfileId ? 'selected' : ''}>
                        ${p.name}
                    </option>
                `).join('');
            
            select.onchange = () => {
                state.activeProfileId = select.value || null;
                updateFeedsList();
                updateStats();
                saveState();
            };
            
            updateStats();
        }

        // === –§–ò–î–´ ===
        
        function addFeedToProfile() {
            if (!state.activeProfileId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å');
                return;
            }
            
            const url = document.getElementById('newFeedUrl').value.trim();
            if (!url) {
                alert('–í–≤–µ–¥–∏—Ç–µ RSS.app URL');
                return;
            }
            
            if (!url.includes('rss.app')) {
                alert('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫–∏ —Å rss.app');
                return;
            }
            
            const profile = state.profiles.find(p => p.id === state.activeProfileId);
            if (!profile) return;
            
            if (profile.feeds.includes(url)) {
                alert('–≠—Ç–æ—Ç —Ñ–∏–¥ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω');
                return;
            }
            
            profile.feeds.push(url);
            document.getElementById('newFeedUrl').value = '';
            updateFeedsList();
            saveState();
        }

        function updateFeedsList() {
            const container = document.getElementById('feedsList');
            
            if (!state.activeProfileId) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px 10px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</div>';
                return;
            }
            
            const profile = state.profiles.find(p => p.id === state.activeProfileId);
            if (!profile || profile.feeds.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px 10px;">–ù–µ—Ç —Ñ–∏–¥–æ–≤</div>';
                return;
            }
            
            container.innerHTML = profile.feeds.map((feed, idx) => `
                <div class="feed-list-item">
                    <div class="feed-url" title="${feed}">${feed}</div>
                    <button class="btn btn-secondary btn-small" onclick="removeFeed(${idx})">√ó</button>
                </div>
            `).join('');
        }

        function removeFeed(index) {
            const profile = state.profiles.find(p => p.id === state.activeProfileId);
            if (!profile) return;
            
            profile.feeds.splice(index, 1);
            updateFeedsList();
            saveState();
        }

        // === –ú–û–ù–ò–¢–û–†–ò–ù–ì ===
        
        function toggleMonitoring() {
            if (!state.monitoring) {
                startMonitoring();
            } else {
                stopMonitoring();
            }
        }

        function startMonitoring() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('–í–≤–µ–¥–∏—Ç–µ Perplexity API Key');
                return;
            }
            
            if (!state.activeProfileId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å');
                return;
            }
            
            const profile = state.profiles.find(p => p.id === state.activeProfileId);
            if (!profile || profile.feeds.length === 0) {
                alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω RSS.app —Ñ–∏–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å');
                return;
            }
            
            state.monitoring = true;
            document.getElementById('startMonitoring').textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥';
            document.getElementById('startMonitoring').style.background = '#e68161';
            document.getElementById('statusIndicator').classList.add('active');
            document.getElementById('statusText').textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
            
            checkForNewPosts();
            
            const intervalMinutes = parseInt(document.getElementById('checkInterval').value);
            state.checkInterval = setInterval(checkForNewPosts, intervalMinutes * 60 * 1000);
            updateNextCheckTime(intervalMinutes);
        }

        function stopMonitoring() {
            state.monitoring = false;
            document.getElementById('startMonitoring').textContent = '–ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥';
            document.getElementById('startMonitoring').style.background = '';
            document.getElementById('statusIndicator').classList.remove('active');
            document.getElementById('statusText').textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            document.getElementById('nextCheck').textContent = '‚Äî';
            
            if (state.checkInterval) {
                clearInterval(state.checkInterval);
                state.checkInterval = null;
            }
        }

        function updateNextCheckTime(minutes) {
            if (!state.monitoring) return;
            
            state.nextCheckTime = new Date(Date.now() + minutes * 60 * 1000);
            document.getElementById('nextCheck').textContent = state.nextCheckTime.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function checkForNewPosts() {
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤...');
            
            const profile = state.profiles.find(p => p.id === state.activeProfileId);
            if (!profile || profile.feeds.length === 0) return;
            
            let totalNewPosts = 0;
            
            for (const feedUrl of profile.feeds) {
                try {
                    const response = await fetch(feedUrl);
                    
                    if (!response.ok) {
                        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${feedUrl}: HTTP ${response.status}`);
                        continue;
                    }
                    
                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                    
                    const items = xmlDoc.getElementsByTagName('item');
                    const entries = xmlDoc.getElementsByTagName('entry');
                    const feedItems = items.length > 0 ? items : entries;
                    
                    for (let i = 0; i < Math.min(feedItems.length, 20); i++) {
                        const item = feedItems[i];
                        
                        const titleEl = item.getElementsByTagName('title')[0];
                        const linkEl = item.getElementsByTagName('link')[0];
                        const descEl = item.getElementsByTagName('description')[0] ||
                                       item.getElementsByTagName('content')[0] ||
                                       item.getElementsByTagName('summary')[0];
                        const pubDateEl = item.getElementsByTagName('pubDate')[0] ||
                                          item.getElementsByTagName('published')[0] ||
                                          item.getElementsByTagName('updated')[0];
                        
                        if (!titleEl && !descEl) continue;
                        
                        const title = titleEl ? titleEl.textContent : '';
                        let description = descEl ? descEl.textContent : '';
                        
                        if (description) {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = description;
                            description = tempDiv.textContent || tempDiv.innerText || '';
                        }
                        
                        const text = (title + ' ' + description).trim();
                        const link = (linkEl && (linkEl.getAttribute('href') || linkEl.textContent)) || '';
                        const postId = link || text.substring(0, 120);
                        
                        const channelTitleEl = xmlDoc.getElementsByTagName('title')[0];
                        const channel = channelTitleEl ? channelTitleEl.textContent : 'RSS.app feed';
                        
                        const timestamp = pubDateEl ? new Date(pubDateEl.textContent) : new Date();
                        
                        const dateFilterDays = parseInt(document.getElementById('dateFilter').value);
                        if (dateFilterDays > 0) {
                            const cutoff = new Date();
                            cutoff.setDate(cutoff.getDate() - dateFilterDays);
                            if (timestamp < cutoff) {
                                state.processedPostIds.add(postId);
                                continue;
                            }
                        }
                        
                        if (state.processedPostIds.has(postId)) continue;
                        
                        if (!matchesKeywords(text, profile.keywords)) continue;
                        
                        const post = {
                            id: postId,
                            channel,
                            text: text.length > 500 ? text.substring(0, 500) + '...' : text,
                            timestamp,
                            link,
                            feedSource: feedUrl
                        };
                        
                        state.posts.unshift(post);
                        state.processedPostIds.add(postId);
                        totalNewPosts++;
                    }
                    
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ${feedUrl}:`, error);
                }
            }
            
            state.stats.postsChecked += totalNewPosts;
            
            if (totalNewPosts > 0) {
                renderPosts();
                updateStats();
                saveState();
                
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('–ù–æ–≤—ã–µ –ø–æ—Å—Ç—ã –∏–∑ RSS.app', {
                        body: `–ù–∞–π–¥–µ–Ω–æ ${totalNewPosts} –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤`
                    });
                }
            }
            
            console.log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤: ${totalNewPosts}`);
            document.getElementById('statusText').textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
            
            updateNextCheckTime(parseInt(document.getElementById('checkInterval').value));
        }

        function matchesKeywords(text, keywords) {
            if (keywords.length === 0) return true;
            const lowerText = text.toLowerCase();
            return keywords.some(kw => lowerText.includes(kw.toLowerCase()));
        }

        function renderPosts() {
            const container = document.getElementById('feedContainer');
            
            if (state.posts.length === 0) {
                container.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤</div>';
                return;
            }
            
            container.innerHTML = state.posts.map((post, index) => `
                <div class="feed-item ${state.selectedPost?.id === post.id ? 'selected' : ''}" onclick="selectPost(${index})">
                    <div class="feed-item-header">
                        <span>${post.channel}</span>
                        <span>${new Date(post.timestamp).toLocaleString('ru-RU')}</span>
                    </div>
                    <div class="feed-item-text">${post.text}</div>
                    <div class="feed-source-tag">${extractFeedName(post.feedSource)}</div>
                </div>
            `).join('');
        }

        function extractFeedName(url) {
            try {
                const match = url.match(/feeds\/([^.]+)/);
                return match ? match[1].substring(0, 12) : 'RSS feed';
            } catch {
                return 'RSS feed';
            }
        }

        function selectPost(index) {
            state.selectedPost = state.posts[index];
            renderPosts();
            
            document.getElementById('generationArea').style.display = 'block';
            document.getElementById('noPostSelected').style.display = 'none';
            document.getElementById('commentPreviewArea').style.display = 'none';
            document.getElementById('editArea').style.display = 'none';
            
            document.getElementById('selectedPostPreview').textContent = 
                state.selectedPost.text.substring(0, 200) + '...';
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
            
            document.querySelectorAll('.tab')[3].classList.add('active');
            document.getElementById('tab-comments').style.display = 'block';
        }

        // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í ===
        
        async function generateComment() {
            if (!state.selectedPost) return;
            
            const btn = document.querySelector('#generationArea .btn-primary');
            btn.disabled = true;
            btn.textContent = '–ì–µ–Ω–µ—Ä–∏—Ä—É—é...';
            
            try {
                const comment = await generateCommentWithPerplexity();
                document.getElementById('generatedComment').textContent = comment;
                document.getElementById('commentPreviewArea').style.display = 'block';
                state.stats.commentsGenerated++;
                updateStats();
                saveState();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
            }
        }

        async function generateCommentWithPerplexity() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) throw new Error('–í–≤–µ–¥–∏—Ç–µ Perplexity API Key');
            
            const postText = state.selectedPost.text;
            const style = document.getElementById('commentStyle').value;
            
            const stylePrompts = {
                professional: '–ù–∞–ø–∏—à–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –∫ —ç—Ç–æ–º—É –ø–æ—Å—Ç—É. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–ª–∂–µ–Ω –¥–æ–±–∞–≤–ª—è—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—É –≤ IT –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –ë–µ–∑ —ç–º–æ–¥–∑–∏.',
                friendly: '–ù–∞–ø–∏—à–∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –∫ —ç—Ç–æ–º—É –ø–æ—Å—Ç—É. –ü–æ–∫–∞–∂–∏ –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç –∏ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Ç–µ–º–æ–π. –ë–µ–∑ —ç–º–æ–¥–∑–∏.',
                expert: '–ù–∞–ø–∏—à–∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –∫ —ç—Ç–æ–º—É –ø–æ—Å—Ç—É. –ó–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–¥–µ–ª–∏—Å—å –≥–ª—É–±–æ–∫–∏–º –∏–Ω—Å–∞–π—Ç–æ–º. –ë–µ–∑ —ç–º–æ–¥–∑–∏.',
                question: '–ù–∞–ø–∏—à–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π-–≤–æ–ø—Ä–æ—Å (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –∫ —ç—Ç–æ–º—É –ø–æ—Å—Ç—É. –ó–∞–¥–∞–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π. –ë–µ–∑ —ç–º–æ–¥–∑–∏.'
            };
            
            const systemPrompt = `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –≤ –æ–±–ª–∞—Å—Ç–∏ IT, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –∏ AI. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–æ—Å—Ç—É –≤ Telegram-–∫–∞–Ω–∞–ª–µ.

–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –î–ª–∏–Ω–∞: 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–º–∞–∫—Å–∏–º—É–º 300 —Å–∏–º–≤–æ–ª–æ–≤)
- –ë–ï–ó —ç–º–æ–¥–∑–∏ –∏ –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω
- –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞
- –î–æ–±–∞–≤–ª—è–π —Ü–µ–Ω–Ω–æ—Å—Ç—å –∏–ª–∏ –∑–∞–¥–∞–≤–∞–π —É–º–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã`;
            
            const userPrompt = `${stylePrompts[style]}

–ü–æ—Å—Ç:
"${postText}"

–¢–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:`;
            
            const response = await fetch('https://api.perplexity.ai/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'llama-3.1-sonar-small-128k-online',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userPrompt }
                    ],
                    temperature: 0.7,
                    max_tokens: 150
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || '–û—à–∏–±–∫–∞ API');
            }
            
            const data = await response.json();
            let comment = data.choices[0].message.content.trim();
            comment = comment.replace(/^["']|["']$/g, '');
            
            if (comment.length > 300) {
                comment = comment.substring(0, 297) + '...';
            }
            
            return comment;
        }

        function regenerateComment() {
            generateComment();
        }

        function editComment() {
            document.getElementById('editArea').style.display = 'block';
            document.getElementById('editedComment').value = 
                document.getElementById('generatedComment').textContent;
        }

        function cancelEdit() {
            document.getElementById('editArea').style.display = 'none';
        }

        function saveEditedComment() {
            const comment = document.getElementById('editedComment').value;
            publishComment(comment);
        }

        function approveComment() {
            const comment = document.getElementById('generatedComment').textContent;
            publishComment(comment);
        }

        function publishComment(comment) {
            navigator.clipboard.writeText(comment).then(() => {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--color-success);
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                `;
                notification.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 4px;">‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!</div>
                    <div style="font-size: 13px; opacity: 0.9;">–û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é</div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
                
                if (state.selectedPost.link && state.selectedPost.link.startsWith('http')) {
                    window.open(state.selectedPost.link, '_blank');
                }
                
                document.getElementById('commentPreviewArea').style.display = 'none';
                document.getElementById('editArea').style.display = 'none';
                state.selectedPost = null;
                document.getElementById('generationArea').style.display = 'none';
                document.getElementById('noPostSelected').style.display = 'block';
                renderPosts();
                
                saveState();
            }).catch(() => {
                alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é:\n\n' + comment);
            });
        }

        // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
        
        function updateStats() {
            document.getElementById('postsChecked').textContent = state.stats.postsChecked;
            document.getElementById('commentsGenerated').textContent = state.stats.commentsGenerated;
            
            const profile = state.profiles.find(p => p.id === state.activeProfileId);
            document.getElementById('activeProfileName').textContent = profile ? profile.name : '‚Äî';
            document.getElementById('activeFeedsCount').textContent = profile ? profile.feeds.length : 0;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // CSS –∞–Ω–∏–º–∞—Ü–∏–∏
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // –ó–∞–ø—Ä–æ—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        document.getElementById('apiKey').addEventListener('change', saveState);
        document.getElementById('checkInterval').addEventListener('change', saveState);
        document.getElementById('dateFilter').addEventListener('change', saveState);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('DOMContentLoaded', () => {
            loadState();
            console.log('‚úÖ RSS Comment Assistant –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
        });

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö
        window.addEventListener('beforeunload', (e) => {
            if (state.monitoring) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
